<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance Records Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    body {
      background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
      color: #333;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      margin-bottom: 30px;
      animation: slideDown 0.7s ease;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo i {
      font-size: 2.5rem;
      color: #6a11cb;
    }
    
    .logo h1 {
      font-size: 2rem;
      color: #2c3e50;
    }
    
    .controls {
      display: flex;
      gap: 15px;
    }
    
    .btn {
      padding: 12px 25px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(to right, #6a11cb, #2575fc);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(to right, #2575fc, #6a11cb);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .btn-success {
      background: linear-gradient(to right, #11998e, #38ef7d);
      color: white;
    }
    
    .btn-success:hover {
      background: linear-gradient(to right, #38ef7d, #11998e);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .btn-warning {
      background: linear-gradient(to right, #FF512F, #F09819);
      color: white;
    }
    
    .btn-warning:hover {
      background: linear-gradient(to right, #F09819, #FF512F);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .btn-danger {
      background: linear-gradient(to right, #FF416C, #FF4B2B);
      color: white;
    }
    
    .btn-danger:hover {
      background: linear-gradient(to right, #FF4B2B, #FF416C);
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }
    
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
      animation: fadeIn 1s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15);
    }
    
    .stat-card h3 {
      font-size: 1.1rem;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    
    .stat-card .value {
      font-size: 2.2rem;
      font-weight: 700;
      color: #2c3e50;
    }
    
    .table-container {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
      margin-bottom: 30px;
      overflow: hidden;
      animation: fadeIn 1.2s ease;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .table-header h2 {
      color: #2c3e50;
      font-size: 1.5rem;
    }
    
    .table-controls {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .search-box {
      display: flex;
      align-items: center;
      background: white;
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
    }
    
    .search-box input {
      border: none;
      outline: none;
      padding: 5px;
      font-size: 1rem;
      width: 250px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    
    th {
      background: linear-gradient(to right, #6a11cb, #2575fc);
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
    }
    
    th:hover {
      background: linear-gradient(to right, #2575fc, #6a11cb);
    }
    
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    
    tr:hover {
      background-color: #eef4ff;
      transform: scale(1.01);
      transition: transform 0.2s ease;
    }
    
    .subject-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin: 2px;
    }
    
    .division-badge {
      display: inline-block;
      width: 30px;
      height: 30px;
      line-height: 30px;
      text-align: center;
      border-radius: 50%;
      background: #eef4ff;
      color: #2575fc;
      font-weight: bold;
    }
    
    .pulse {
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    @keyframes slideDown {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      padding: 15px 25px;
      background: #4CAF50;
      color: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateX(100px);
      opacity: 0;
      transition: all 0.5s ease;
      z-index: 1000;
    }
    
    .toast.show {
      transform: translateX(0);
      opacity: 1;
    }
    
    .toast.error {
      background: #FF416C;
    }
    
    .reset-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }
    
    .reset-modal.show {
      opacity: 1;
      visibility: visible;
    }
    
    .reset-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      transform: translateY(-50px);
      transition: transform 0.5s ease;
    }
    
    .reset-modal.show .reset-content {
      transform: translateY(0);
    }
    
    .reset-content h3 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    
    .reset-content p {
      margin-bottom: 25px;
      color: #7f8c8d;
    }
    
    .reset-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
    }
    
    footer {
      text-align: center;
      color: white;
      padding: 20px;
      font-size: 0.9rem;
    }
    
    @media (max-width: 768px) {
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      header {
        flex-direction: column;
        gap: 20px;
      }
      
      .controls {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      
      .table-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }
      
      .table-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .search-box input {
        width: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <i class="fas fa-chalkboard-teacher"></i>
        <h1>S.P College, Pune - Attendance Dashboard</h1>
      </div>
      <div class="controls">
        <button class="btn btn-primary" id="refreshBtn">
          <i class="fas fa-sync-alt"></i> Refresh Data
        </button>
        <button class="btn btn-success" id="downloadBtn">
          <i class="fas fa-file-excel"></i> Export to Excel
        </button>
        <button class="btn btn-warning" id="sortBtn">
          <i class="fas fa-sort"></i> Sort by Roll No
        </button>
        <button class="btn btn-danger" id="resetBtn">
          <i class="fas fa-trash-alt"></i> Reset Data
        </button>
      </div>
    </header>
    
    <div class="stats-container">
      <div class="stat-card">
        <h3>Total Records</h3>
        <div class="value" id="totalRecords">0</div>
      </div>
      <div class="stat-card">
        <h3>Today's Attendance</h3>
        <div class="value" id="todayRecords">0</div>
      </div>
      <div class="stat-card">
        <h3>Last Updated</h3>
        <div class="value" id="lastUpdated">Just now</div>
      </div>
    </div>
    
    <div class="table-container">
      <div class="table-header">
        <h2>Attendance Records</h2>
        <div class="table-controls">
          <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Search records..." id="searchInput">
          </div>
        </div>
      </div>
      
      <div style="overflow-x: auto;">
        <table>
          <thead>
            <tr>
              <th data-sort="name">Name <i class="fas fa-sort"></i></th>
              <th data-sort="roll">Roll No <i class="fas fa-sort"></i></th>
              <th data-sort="class">Class <i class="fas fa-sort"></i></th>
              <th>Division</th>
              <th>Subject</th>
              <th data-sort="timestamp">Time <i class="fas fa-sort"></i></th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="attendanceTable">
            <tr>
              <td colspan="7" style="text-align: center; padding: 30px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6a11cb;"></i>
                <p style="margin-top: 15px;">Loading attendance data...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">Data exported successfully!</span>
  </div>
  
  <div class="reset-modal" id="resetModal">
    <div class="reset-content">
      <h3>Reset Attendance Data</h3>
      <p>Are you sure you want to reset all attendance data? This action cannot be undone.</p>
      <div class="reset-buttons">
        <button class="btn btn-primary" id="cancelReset">Cancel</button>
        <button class="btn btn-danger" id="confirmReset">Reset Data</button>
      </div>
    </div>
  </div>
  
  <footer>
    <p>© 2025 S.P College, Pune | Developed with ❤️ for accurate tracking</p>
  </footer>

  <audio id="soundEffect" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
  <audio id="resetSound" src="https://assets.mixkit.co/sfx/preview/mixkit-trumpet-fanfare-2293.mp3" preload="auto"></audio>
  <audio id="deleteSound" src="https://assets.mixkit.co/sfx/preview/mixkit-breaking-plastic-2541.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, onSnapshot, deleteDoc, doc, writeBatch } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAvBJ4oiFIrkwQIgB65vhYG1s_sU407DWY",
      authDomain: "prajyotgond.firebaseapp.com",
      projectId: "prajyotgond",
      storageBucket: "prajyotgond.appspot.com",
      messagingSenderId: "747968445282",
      appId: "1:747968445282:web:f7deffceefadd8eeb80a3b",
      measurementId: "G-Y5TQTVX2EK"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // DOM Elements
    const toast = document.getElementById('toast');
    const soundEffect = document.getElementById('soundEffect');
    const resetSound = document.getElementById('resetSound');
    const deleteSound = document.getElementById('deleteSound');
    const refreshBtn = document.getElementById('refreshBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const sortBtn = document.getElementById('sortBtn');
    const resetBtn = document.getElementById('resetBtn');
    const resetModal = document.getElementById('resetModal');
    const cancelReset = document.getElementById('cancelReset');
    const confirmReset = document.getElementById('confirmReset');
    const searchInput = document.getElementById('searchInput');
    const tableHeaders = document.querySelectorAll('th[data-sort]');
    const totalRecordsEl = document.getElementById('totalRecords');
    const todayRecordsEl = document.getElementById('todayRecords');
    const lastUpdatedEl = document.getElementById('lastUpdated');

    // State variables
    let currentData = [];
    let sortDirection = {};

    // Initialize sort directions
    tableHeaders.forEach(header => {
      const key = header.getAttribute('data-sort');
      sortDirection[key] = 1; // 1 for ascending, -1 for descending
    });

    // Play sound function
    function playSound(sound) {
      sound.currentTime = 0;
      sound.play().catch(e => console.log("Sound play prevented by browser: ", e));
    }

    // Show toast notification
    function showToast(message, isError = false) {
      const toastMessage = document.getElementById('toastMessage');
      toastMessage.textContent = message;
      
      if (isError) {
        toast.classList.add('error');
      } else {
        toast.classList.remove('error');
      }
      
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Update stats cards
    function updateStats(data) {
      // Update total records
      totalRecordsEl.textContent = data.length;
      
      // Calculate today's records
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const todayRecords = data.filter(item => {
        if (!item.timestamp) return false;
        const recordDate = new Date(item.timestamp.seconds * 1000);
        recordDate.setHours(0, 0, 0, 0);
        return recordDate.getTime() === today.getTime();
      }).length;
      
      todayRecordsEl.textContent = todayRecords;
      
      // Update last updated time
      lastUpdatedEl.textContent = 'Just now';
    }

    // Sort data by column
    function sortData(key) {
      // Toggle sort direction
      sortDirection[key] = sortDirection[key] === 1 ? -1 : 1;
      
      // Update UI to show sort direction
      tableHeaders.forEach(header => {
        const icon = header.querySelector('i');
        if (header.getAttribute('data-sort') === key) {
          icon.className = sortDirection[key] === 1 ? 
            'fas fa-sort-up' : 'fas fa-sort-down';
        } else {
          icon.className = 'fas fa-sort';
        }
      });
      
      // Sort the data
      currentData.sort((a, b) => {
        let valueA = a[key] || '';
        let valueB = b[key] || '';
        
        // Handle numeric values
        if (key === 'roll') {
          valueA = parseInt(valueA) || 0;
          valueB = parseInt(valueB) || 0;
        }
        
        // Handle date values
        if (key === 'timestamp' && a.timestamp && b.timestamp) {
          valueA = a.timestamp.seconds;
          valueB = b.timestamp.seconds;
        }
        
        if (valueA < valueB) return -1 * sortDirection[key];
        if (valueA > valueB) return 1 * sortDirection[key];
        return 0;
      });
      
      // Render sorted data
      renderTable(currentData);
      playSound(soundEffect);
      showToast(`Data sorted by ${key} ${sortDirection[key] === 1 ? 'ascending' : 'descending'}`);
    }

    // Render table with data
    function renderTable(data) {
      const table = document.getElementById("attendanceTable");
      table.innerHTML = "";
      
      if (data.length === 0) {
        table.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px;">
          No attendance records found.
        </td></tr>`;
        return;
      }
      
      data.forEach((item, index) => {
        const data = item;
        
        // Generate random subject and division for demo purposes
        const subjects = ["English", "Mathematics", "Biology", "Physics", "Chemistry", "SMS"];
        const divisions = ["A", "B", "C", "D", "E", "F", "G"];
        const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
        const randomDivision = divisions[Math.floor(Math.random() * divisions.length)];
        
        // Subject badge color based on subject
        const subjectColors = {
          "English": "#e3f2fd,#0d47a1",
          "Mathematics": "#f3e5f5,#4a148c",
          "Biology": "#f1f8e9,#33691e",
          "Physics": "#ffebee,#b71c1c",
          "Chemistry": "#fff3e0,#e65100",
          "SMS": "#e8f5e9,#1b5e20"
        };
        
        const [bgColor, textColor] = subjectColors[randomSubject].split(',');
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${data.name || 'N/A'}</td>
          <td>${data.roll || 'N/A'}</td>
          <td>${data.class || 'N/A'}</td>
          <td><span class="division-badge">${randomDivision}</span></td>
          <td><span class="subject-badge" style="background: ${bgColor}; color: ${textColor};">${randomSubject}</span></td>
          <td>${data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A'}</td>
          <td><i class="fas fa-check-circle" style="color: #4CAF50;"></i></td>
        `;
        
        // Add animation to new rows
        row.style.opacity = "0";
        table.appendChild(row);
        
        setTimeout(() => {
          row.style.transition = "opacity 0.5s ease";
          row.style.opacity = "1";
        }, index * 50);
      });
    }

    // Filter data based on search input
    function filterData() {
      const searchTerm = searchInput.value.toLowerCase();
      
      if (!searchTerm) {
        renderTable(currentData);
        return;
      }
      
      const filteredData = currentData.filter(item => {
        return (
          (item.name && item.name.toLowerCase().includes(searchTerm)) ||
          (item.roll && item.roll.toString().includes(searchTerm)) ||
          (item.class && item.class.toLowerCase().includes(searchTerm))
        );
      });
      
      renderTable(filteredData);
    }

    async function loadData() {
      try {
        const table = document.getElementById("attendanceTable");
        
        // Add loading animation
        table.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6a11cb;"></i>
          <p style="margin-top: 15px;">Loading attendance data...</p>
        </td></tr>`;
        
        const querySnapshot = await getDocs(collection(db, "attendance"));
        currentData = [];
        
        querySnapshot.forEach((doc) => {
          currentData.push({ id: doc.id, ...doc.data() });
        });
        
        renderTable(currentData);
        updateStats(currentData);
        playSound(soundEffect);
        showToast("Data refreshed successfully!");
        
      } catch (error) {
        console.error("Error loading data: ", error);
        showToast("Error loading data. Please try again.", true);
      }
    }

    async function downloadExcel() {
      try {
        playSound(soundEffect);
        
        // Add pulse animation to button
        downloadBtn.classList.add('pulse');
        setTimeout(() => downloadBtn.classList.remove('pulse'), 1500);
        
        const querySnapshot = await getDocs(collection(db, "attendance"));
        let rows = [["Name", "Roll No", "Class", "Division", "Subject", "Timestamp"]];
        
        // Sample subjects and divisions for demo
        const subjects = ["English", "Mathematics", "Biology", "Physics", "Chemistry", "SMS"];
        const divisions = ["A", "B", "C", "D", "E", "F", "G"];

        querySnapshot.forEach((doc) => {
          const data = doc.data();
          const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
          const randomDivision = divisions[Math.floor(Math.random() * divisions.length)];
          
          rows.push([
            data.name || 'N/A',
            data.roll || 'N/A',
            data.class || 'N/A',
            randomDivision,
            randomSubject,
            data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleString() : 'N/A'
          ]);
        });
        
        const worksheet = XLSX.utils.aoa_to_sheet(rows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Attendance");
        
        // Generate Excel file and trigger download
        XLSX.writeFile(workbook, "attendance_records.xlsx");
        
        showToast("Excel file downloaded successfully!");
        
      } catch (error) {
        console.error("Error downloading Excel: ", error);
        showToast("Error downloading file. Please try again.", true);
      }
    }

    async function resetData() {
      try {
        // Close modal
        resetModal.classList.remove('show');
        
        // Show loading state
        const table = document.getElementById("attendanceTable");
        table.innerHTML = `<tr><td colspan="7" style="text-align: center; padding: 30px;">
          <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #6a11cb;"></i>
          <p style="margin-top: 15px;">Resetting attendance data...</p>
        </td></tr>`;
        
        playSound(deleteSound);
        
        // Get all documents and delete them
        const querySnapshot = await getDocs(collection(db, "attendance"));
        const batch = writeBatch(db);
        
        querySnapshot.forEach((document) => {
          batch.delete(doc(db, "attendance", document.id));
        });
        
        await batch.commit();
        
        // Update UI
        currentData = [];
        renderTable(currentData);
        updateStats(currentData);
        
        playSound(resetSound);
        showToast("All attendance data has been reset!");
        
      } catch (error) {
        console.error("Error resetting data: ", error);
        showToast("Error resetting data. Please try again.", true);
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Initial data load
      loadData();
      
      // Set up event listeners
      refreshBtn.addEventListener("click", loadData);
      downloadBtn.addEventListener("click", downloadExcel);
      sortBtn.addEventListener("click", () => sortData('roll'));
      resetBtn.addEventListener("click", () => resetModal.classList.add('show'));
      cancelReset.addEventListener("click", () => resetModal.classList.remove('show'));
      confirmReset.addEventListener("click", resetData);
      searchInput.addEventListener("input", filterData);
      
      // Add sort functionality to table headers
      tableHeaders.forEach(header => {
        header.addEventListener('click', () => {
          const key = header.getAttribute('data-sort');
          sortData(key);
        });
      });
      
      // Add animation to table rows on load
      const rows = document.querySelectorAll('tr');
      rows.forEach((row, index) => {
        row.style.animationDelay = `${index * 0.1}s`;
      });
    });
  </script>
</body>
</html>